<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - View Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .order-card {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 5px solid #27ae60;
        }
        .order-card h3 {
            margin-top: 0;
            color: #27ae60;
        }
        .order-card p {
            margin: 5px 0;
        }
        .no-orders {
            text-align: center;
            color: #7f8c8d;
            padding: 40px;
        }
        .clear-btn {
            background-color: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }
        .clear-btn:hover {
            background-color: #c0392b;
        }
        .refresh-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        .refresh-btn i {
            animation: none;
        }
        .refresh-btn.refreshing i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .admin-actions {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        #loginForm {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .login-btn {
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        .login-btn:hover {
            background-color: #219a52;
        }
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            text-align: center;
        }
        #adminContent {
            display: none;
        }
        .order-status {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .status-select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .status-select.pending {
            border-color: #f1c40f;
        }
        
        .status-select.processing {
            border-color: #3498db;
        }
        
        .status-select.completed {
            border-color: #27ae60;
        }
        
        .status-select.cancelled {
            border-color: #e74c3c;
        }

        .save-status {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            background-color: #27ae60;
            color: white;
            cursor: pointer;
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-status.show {
            opacity: 1;
        }

        .save-status:hover {
            background-color: #219a52;
        }

        /* Add status colors */
        .status-pending {
            background-color: #f1c40f;
            color: #000;
        }
        
        .status-processing {
            background-color: #3498db;
            color: #fff;
        }
        
        .status-completed {
            background-color: #27ae60;
            color: #fff;
        }
        
        .status-cancelled {
            background-color: #e74c3c;
            color: #fff;
        }

        .export-btn {
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            background-color: #219a52;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #27ae60;
            color: white;
            border-radius: 5px;
            transform: translateX(200%);
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div id="loginForm">
        <h2 style="text-align: center; margin-bottom: 20px;">Admin Login</h2>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter admin password">
        </div>
        <button class="login-btn" onclick="login()">Login</button>
        <p id="errorMessage" class="error-message"></p>
    </div>

    <div id="adminContent" class="container">
        <h1>Order Management</h1>
        <div class="admin-actions">
            <button id="refreshOrders" class="refresh-btn" onclick="refreshOrders()">
                <i class="fas fa-sync-alt"></i> Refresh Orders
            </button>
            <button class="export-btn" onclick="exportPendingOrders()">
                <i class="fas fa-file-excel"></i> Export Pending Orders
            </button>
            <button id="clearOrders" class="clear-btn" onclick="clearPendingOrders()">Clear Pending Orders</button>
            <button id="logout" class="clear-btn" style="background-color: #7f8c8d;" onclick="logout()">Logout</button>
        </div>
        <div id="ordersList"></div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Simple password protection
        const ADMIN_PASSWORD = 'av09'; // Changed password to av09

        function login() {
            const password = document.getElementById('password').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadOrders();
            } else {
                document.getElementById('errorMessage').textContent = 'Incorrect password';
            }
        }

        function logout() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('password').value = '';
            document.getElementById('errorMessage').textContent = '';
        }

        function loadOrders() {
            const ordersList = document.getElementById('ordersList');
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');

            if (orders.length === 0) {
                ordersList.innerHTML = '<div class="no-orders">No orders found</div>';
                return;
            }

            ordersList.innerHTML = orders.map((order, index) => `
                <div class="order-card">
                    <h3>Order #${index + 1} - ${order.timestamp}</h3>
                    <p><strong>Customer Name:</strong> ${order.fullName}</p>
                    <p><strong>Email:</strong> ${order.email}</p>
                    <p><strong>Phone:</strong> ${order.phone}</p>
                    <p><strong>Delivery Address:</strong> ${order.address}</p>
                    ${order.deliveryInstructions ? `<p><strong>Delivery Instructions:</strong> ${order.deliveryInstructions}</p>` : ''}
                    ${order.items ? `
                        <div class="order-items">
                            <h4>Order Items:</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${order.items.map(item => `
                                    <li style="margin-bottom: 5px;">
                                        ${item.quantity}x ${item.name} - $${(item.price * item.quantity).toFixed(2)}
                                    </li>
                                `).join('')}
                            </ul>
                            <p><strong>Subtotal:</strong> $${order.subtotal ? order.subtotal.toFixed(2) : '0.00'}</p>
                            <p><strong>Tax:</strong> $${order.tax ? order.tax.toFixed(2) : '0.00'}</p>
                            <p><strong>Total:</strong> $${order.total ? order.total.toFixed(2) : '0.00'}</p>
                        </div>
                    ` : ''}
                    <div class="order-status status-${order.status ? order.status.toLowerCase() : 'pending'}">
                        <select class="status-select ${order.status ? order.status.toLowerCase() : 'pending'}" 
                                onchange="handleStatusChange(this, ${index})" 
                                data-order-index="${index}">
                            <option value="Pending" ${!order.status || order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                        <button class="save-status" onclick="saveStatus(${index})" id="save-${index}">
                            Save
                        </button>
                    </div>
                </div>
            `).join('');

            // Add event listeners for status changes
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', function() {
                    const orderIndex = this.dataset.orderIndex;
                    handleStatusChange(this, orderIndex);
                });
            });
        }

        function handleStatusChange(selectElement, orderIndex) {
            const saveButton = document.getElementById(`save-${orderIndex}`);
            const newStatus = selectElement.value;
            
            // Update select element class
            selectElement.className = `status-select ${newStatus.toLowerCase()}`;
            
            // Show save button
            saveButton.classList.add('show');
            
            // Update status container class
            const statusContainer = selectElement.parentElement;
            statusContainer.className = `order-status status-${newStatus.toLowerCase()}`;
        }

        function saveStatus(orderIndex) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const selectElement = document.querySelector(`select[data-order-index="${orderIndex}"]`);
            const saveButton = document.getElementById(`save-${orderIndex}`);
            const newStatus = selectElement.value;

            // Update order status
            orders[orderIndex].status = newStatus;
            
            // Save to localStorage
            localStorage.setItem('orders', JSON.stringify(orders));
            
            // Hide save button
            saveButton.classList.remove('show');
            
            // Show notification
            showNotification(`Order #${orderIndex + 1} status updated to ${newStatus}`);

            // If status is Completed or Cancelled, and auto-export is needed
            if ((newStatus === 'Completed' || newStatus === 'Cancelled') && orders[orderIndex]) {
                exportToExcel([orders[orderIndex]]);
            }
        }

        function refreshOrders() {
            const refreshBtn = document.getElementById('refreshOrders');
            refreshBtn.classList.add('refreshing');
            
            // Add a small delay to show the refresh animation
            setTimeout(() => {
                loadOrders();
                refreshBtn.classList.remove('refreshing');
                showNotification('Orders refreshed successfully!');
            }, 500);
        }

        function exportToExcel(orders) {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // 1. Orders Worksheet - Detailed order information
            const formattedOrders = orders.map(order => ({
                'Order ID': `#${order.id || Math.floor(Math.random() * 10000)}`,
                'Customer Name': order.fullName || 'N/A',
                'Email': order.email || 'N/A',
                'Phone': order.phone || 'N/A',
                'Address': order.address || 'N/A',
                'Items': order.items ? order.items.map(item => `${item.quantity}x ${item.name}`).join(', ') : 'N/A',
                'Subtotal': order.subtotal ? `$${order.subtotal.toFixed(2)}` : 'N/A',
                'Tax': order.tax ? `$${order.tax.toFixed(2)}` : 'N/A',
                'Total Amount': order.total ? `$${order.total.toFixed(2)}` : 'N/A',
                'Status': order.status || 'Pending',
                'Timestamp': order.timestamp || 'N/A',
                'Delivery Instructions': order.deliveryInstructions || 'N/A'
            }));
            
            // Add orders worksheet
            const ordersWS = XLSX.utils.json_to_sheet(formattedOrders);
            XLSX.utils.book_append_sheet(wb, ordersWS, "Orders Summary");

            // 2. Customer Details Worksheet - Unique customers with their information
            const customers = {};
            orders.forEach(order => {
                const email = order.email || 'N/A';
                if (!customers[email]) {
                    customers[email] = {
                        'Customer Name': order.fullName || 'N/A',
                        'Email': email,
                        'Phone': order.phone || 'N/A',
                        'Address': order.address || 'N/A',
                        'Total Orders': 1,
                        'Total Spent': order.total || 0,
                        'Last Order Date': order.timestamp || 'N/A',
                        'Delivery Instructions': order.deliveryInstructions || 'N/A'
                    };
                } else {
                    customers[email]['Total Orders']++;
                    customers[email]['Total Spent'] += order.total || 0;
                    customers[email]['Last Order Date'] = order.timestamp || customers[email]['Last Order Date'];
                }
            });

            const customersList = Object.values(customers).map(customer => ({
                ...customer,
                'Total Spent': `$${customer['Total Spent'].toFixed(2)}`
            }));

            const customersWS = XLSX.utils.json_to_sheet(customersList);
            XLSX.utils.book_append_sheet(wb, customersWS, "Customer Details");

            // 3. Items Summary Worksheet - Product statistics
            const items = {};
            orders.forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        if (!items[item.name]) {
                            items[item.name] = {
                                'Product Name': item.name,
                                'Total Quantity Ordered': item.quantity,
                                'Total Revenue': item.price * item.quantity,
                                'Number of Orders': 1,
                                'Average Quantity per Order': item.quantity
                            };
                        } else {
                            items[item.name]['Total Quantity Ordered'] += item.quantity;
                            items[item.name]['Total Revenue'] += item.price * item.quantity;
                            items[item.name]['Number of Orders']++;
                            items[item.name]['Average Quantity per Order'] = 
                                items[item.name]['Total Quantity Ordered'] / items[item.name]['Number of Orders'];
                        }
                    });
                }
            });

            const itemsList = Object.values(items).map(item => ({
                ...item,
                'Total Revenue': `$${item['Total Revenue'].toFixed(2)}`,
                'Average Quantity per Order': item['Average Quantity per Order'].toFixed(2)
            }));

            const itemsWS = XLSX.utils.json_to_sheet(itemsList);
            XLSX.utils.book_append_sheet(wb, itemsWS, "Items Summary");

            // 4. Order Timeline Worksheet - Chronological order history
            const timelineOrders = orders.map(order => ({
                'Date & Time': order.timestamp || 'N/A',
                'Order ID': `#${order.id || Math.floor(Math.random() * 10000)}`,
                'Customer': order.fullName || 'N/A',
                'Items Count': order.items ? order.items.length : 0,
                'Total Amount': order.total ? `$${order.total.toFixed(2)}` : 'N/A',
                'Status': order.status || 'Pending'
            })).sort((a, b) => new Date(b['Date & Time']) - new Date(a['Date & Time']));

            const timelineWS = XLSX.utils.json_to_sheet(timelineOrders);
            XLSX.utils.book_append_sheet(wb, timelineWS, "Order Timeline");

            // 5. Analytics Worksheet - Summary statistics
            const analytics = [{
                'Metric': 'Total Orders',
                'Value': orders.length
            }, {
                'Metric': 'Total Revenue',
                'Value': `$${orders.reduce((sum, order) => sum + (order.total || 0), 0).toFixed(2)}`
            }, {
                'Metric': 'Unique Customers',
                'Value': Object.keys(customers).length
            }, {
                'Metric': 'Average Order Value',
                'Value': `$${(orders.reduce((sum, order) => sum + (order.total || 0), 0) / orders.length).toFixed(2)}`
            }, {
                'Metric': 'Total Products Sold',
                'Value': Object.values(items).reduce((sum, item) => sum + item['Total Quantity Ordered'], 0)
            }];

            const analyticsWS = XLSX.utils.json_to_sheet(analytics);
            XLSX.utils.book_append_sheet(wb, analyticsWS, "Analytics");
            
            // Generate filename with current date and time
            const date = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const fileName = `snacksmart_orders_${date}.xlsx`;
            
            // Save the file
            XLSX.writeFile(wb, fileName);
            
            showNotification('Orders exported to Excel successfully with complete customer information!');
        }

        function exportPendingOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const pendingOrders = orders.filter(order => order.status === 'Pending');
            
            if (pendingOrders.length > 0) {
                exportToExcel(pendingOrders);
            } else {
                showNotification('No pending orders to export!');
            }
        }

        function clearPendingOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const pendingOrders = orders.filter(order => order.status === 'Pending');
            
            if (pendingOrders.length > 0) {
                if (confirm(`Are you sure you want to clear ${pendingOrders.length} pending orders? They will be exported to Excel first.`)) {
                    // Export to Excel before clearing
                    exportToExcel(pendingOrders);
                    
                    // Remove pending orders
                    const remainingOrders = orders.filter(order => order.status !== 'Pending');
                    localStorage.setItem('orders', JSON.stringify(remainingOrders));
                    
                    // Refresh the display
                    loadOrders();
                    showNotification(`${pendingOrders.length} pending orders exported and cleared!`);
                }
            } else {
                showNotification('No pending orders to clear!');
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Handle Enter key in password field
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html> 